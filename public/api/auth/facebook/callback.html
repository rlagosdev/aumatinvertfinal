<!DOCTYPE html>
<html>
<head>
    <title>Facebook OAuth Callback</title>
</head>
<body>
    <script>
        // Cette page re√ßoit le code OAuth de Facebook et le renvoie √† la fen√™tre parente

        // IMPORTANT: Ex√©cuter une seule fois, m√™me si la page se recharge
        const PROCESSING_KEY = 'facebook_oauth_processing';

        if (sessionStorage.getItem(PROCESSING_KEY) === 'true') {
            console.log('‚ö†Ô∏è OAuth d√©j√† en cours de traitement, fermeture...');
            window.close();
            throw new Error('Already processing');
        }

        sessionStorage.setItem(PROCESSING_KEY, 'true');

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        // üîç LOG D√âTAILL√â: Afficher le code re√ßu pour d√©boguer
        console.log('üì• Code OAuth re√ßu de Facebook:', code);
        console.log('üì• State re√ßu:', state);
        console.log('üì• URL compl√®te:', window.location.href);

        // Sauvegarder le code dans sessionStorage pour voir si c'est toujours le m√™me
        const lastCode = sessionStorage.getItem('last_oauth_code');
        if (lastCode === code) {
            console.error('‚ö†Ô∏è ATTENTION: Facebook a renvoy√© le M√äME code OAuth que la tentative pr√©c√©dente!');
            console.error('Code pr√©c√©dent:', lastCode);
            console.error('Code actuel:', code);
        } else {
            console.log('‚úÖ Nouveau code OAuth re√ßu (diff√©rent du pr√©c√©dent)');
            sessionStorage.setItem('last_oauth_code', code);
        }

        // Nettoyer imm√©diatement l'URL pour √©viter les r√©utilisations
        if (code && window.history.replaceState) {
            window.history.replaceState({}, document.title, window.location.pathname);
            console.log('üßπ URL nettoy√©e pour √©viter la r√©utilisation');
        }

        if (error) {
            // Envoyer l'erreur √† la fen√™tre parente
            window.opener.postMessage({
                type: 'facebook-auth-error',
                error: errorDescription || error
            }, window.location.origin);
            window.close();
        } else if (code) {
            // V√©rifier le state CSRF
            const storedState = localStorage.getItem('facebook_oauth_state');

            if (state !== storedState) {
                window.opener.postMessage({
                    type: 'facebook-auth-error',
                    error: '√âtat CSRF invalide'
                }, window.location.origin);
                window.close();
                return;
            }

            // √âchanger le code contre un token et r√©cup√©rer les pages
            exchangeCodeAndFetchPages(code);
        } else {
            window.opener.postMessage({
                type: 'facebook-auth-error',
                error: 'Aucun code re√ßu de Facebook'
            }, window.location.origin);
            window.close();
        }

        async function exchangeCodeAndFetchPages(code) {
            try {
                // Obtenir le token courte dur√©e
                // IMPORTANT : En production, cet √©change devrait se faire c√¥t√© serveur
                // pour ne pas exposer le client_secret
                const tokenUrl = `https://graph.facebook.com/v18.0/oauth/access_token?` +
                    `client_id=${getAppId()}&` +
                    `client_secret=${getAppSecret()}&` +
                    `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&` +
                    `code=${code}`;

                console.log('üîÑ √âchange du code OAuth en cours...');
                console.log('üì§ Code envoy√© √† Facebook:', code);

                const tokenResponse = await fetch(tokenUrl);

                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    console.error('‚ùå Erreur Facebook Graph API:', errorText);
                    console.error('üì§ Code qui a caus√© l\'erreur:', code);
                    throw new Error('Erreur lors de l\'√©change du code OAuth: ' + errorText);
                }

                console.log('‚úÖ Code OAuth √©chang√© avec succ√®s');

                const tokenData = await tokenResponse.json();
                const userToken = tokenData.access_token;

                console.log('üîë Token utilisateur obtenu:', userToken.substring(0, 20) + '...');

                // R√©cup√©rer les pages de l'utilisateur
                const pagesUrl = `https://graph.facebook.com/v18.0/me/accounts?` +
                    `fields=id,name,username,access_token,picture&` +
                    `access_token=${userToken}`;

                console.log('üì° R√©cup√©ration des pages Facebook...');
                const pagesResponse = await fetch(pagesUrl);

                if (!pagesResponse.ok) {
                    const errorText = await pagesResponse.text();
                    console.error('‚ùå Erreur API pages:', errorText);
                    throw new Error('Erreur lors de la r√©cup√©ration des pages Facebook: ' + errorText);
                }

                const pagesData = await pagesResponse.json();
                console.log('üìÑ R√©ponse compl√®te de l\'API Facebook:', pagesData);

                const pages = pagesData.data || [];
                console.log('üìä Nombre de pages trouv√©es:', pages.length);

                if (pages.length > 0) {
                    console.log('üìã D√©tails des pages:', pages);
                }

                if (pages.length === 0) {
                    console.error('‚ö†Ô∏è Aucune page trouv√©e dans la r√©ponse API');
                    console.error('üîç R√©ponse brute:', JSON.stringify(pagesData, null, 2));
                    throw new Error(`Aucune page Facebook trouv√©e.

üí° Pour utiliser l'API Facebook, vous devez :
1. Cr√©er une Page Facebook (pas juste un profil)
2. √ätre administrateur de cette page
3. R√©essayer la connexion

Cr√©ez une page ici : https://www.facebook.com/pages/create`);
                }

                // Sauvegarder les comptes dans Supabase
                const savedAccounts = await saveAccountsToSupabase(pages);

                // Envoyer le succ√®s √† la fen√™tre parente
                window.opener.postMessage({
                    type: 'facebook-auth-success',
                    accountsCount: savedAccounts
                }, window.location.origin);

                // Nettoyer le flag de traitement
                sessionStorage.removeItem(PROCESSING_KEY);

                window.close();
            } catch (error) {
                console.error('Erreur:', error);
                window.opener.postMessage({
                    type: 'facebook-auth-error',
                    error: error.message
                }, window.location.origin);

                // Nettoyer le flag de traitement m√™me en cas d'erreur
                sessionStorage.removeItem(PROCESSING_KEY);

                window.close();
            }
        }

        async function saveAccountsToSupabase(pages) {
            // Utiliser l'API Supabase pour sauvegarder les comptes
            // Note: Ceci n√©cessite que Supabase soit accessible depuis cette page

            const supabaseUrl = getSupabaseUrl();
            const supabaseKey = getSupabaseKey();

            if (!supabaseUrl || !supabaseKey) {
                throw new Error('Configuration Supabase manquante');
            }

            // R√©cup√©rer l'ID utilisateur depuis le localStorage
            // Supabase stocke la session dans une cl√© qui suit ce pattern : sb-{project_id}-auth-token
            const projectId = supabaseUrl.split('//')[1].split('.')[0]; // "bvvekjhvmorgdvleobdo"
            const sessionKey = `sb-${projectId}-auth-token`;

            let userId;
            try {
                const sessionData = localStorage.getItem(sessionKey);
                if (!sessionData) {
                    throw new Error('Session non trouv√©e dans localStorage');
                }

                const session = JSON.parse(sessionData);
                userId = session?.user?.id;

                if (!userId) {
                    throw new Error('ID utilisateur non trouv√© dans la session');
                }

                console.log('‚úÖ User ID r√©cup√©r√©:', userId);
            } catch (err) {
                console.error('‚ùå Erreur r√©cup√©ration user ID:', err);
                throw new Error('Utilisateur non connect√©. Veuillez vous reconnecter √† l\'application.');
            }

            let savedCount = 0;

            for (const page of pages) {
                try {
                    const response = await fetch(`${supabaseUrl}/rest/v1/social_accounts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`,
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            platform: 'facebook',
                            platform_user_id: page.id,
                            platform_username: page.username || page.name,
                            page_name: page.name,
                            profile_picture_url: page.picture?.data?.url,
                            access_token: page.access_token,
                            is_active: true
                        })
                    });

                    if (response.ok) {
                        savedCount++;
                    }
                } catch (err) {
                    console.error('Erreur sauvegarde page:', err);
                }
            }

            return savedCount;
        }

        function getAppId() {
            // Instagram App ID depuis .env
            return '801122365840416';
        }

        function getAppSecret() {
            // Instagram App Secret depuis .env
            // ‚ö†Ô∏è ATTENTION : En production, ceci ne devrait JAMAIS √™tre expos√© c√¥t√© client !
            // Cette impl√©mentation est temporaire pour le d√©veloppement local uniquement.
            // Pour la production, cr√©ez une Supabase Edge Function pour √©changer le code c√¥t√© serveur.
            return '4b6aaefca0cf76ca1ad65c6041846ee6';
        }

        function getSupabaseUrl() {
            // Supabase URL depuis .env
            return 'https://bvvekjhvmorgdvleobdo.supabase.co';
        }

        function getSupabaseKey() {
            // Supabase Anon Key depuis .env (cl√© publique, s√©curis√©e)
            return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dmVramh2bW9yZ2R2bGVvYmRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDA1NDcsImV4cCI6MjA3NTY3NjU0N30.HoR5ektpKVy4nudbUvGBdWDyKsHqHy1u7Yw1CPVJ-eM';
        }
    </script>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>Connexion √† Facebook...</h2>
        <p>Veuillez patienter pendant que nous finalisons la connexion.</p>
    </div>
</body>
</html>
